<div th:fragment="eshopperAuthen" class="contact-form bg-white">
  <div id="success"></div>
  <div class="p-5">
    <h4 class="pb-4">Đăng nhập</h4>
    <form name="sentMessage" id="user-login" novalidate="novalidate">
      <div class="control-group">
        <input type="email" class="form-control" name="email" placeholder="Địa chỉ email" required="required"
          data-validation-required-message="Bạn chưa nhập địa chỉ email" />
        <p class="help-block text-danger"></p>
      </div>
      <div class="control-group">
        <input type="password" class="form-control" name="password" placeholder="Mật khẩu" required="required"
          data-validation-required-message="Bạn chưa nhập mật khẩu" />
        <p class="help-block text-danger"></p>
      </div>
      <div id="user-loginerror" style="display:none;">
        <p>Sai thông tin đăng nhập</p>
      </div>
      <div>
        <button class="btn btn-primary py-2 px-4" type="button" id="user-loginbutton">Đăng nhập</button>
      </div>
    </form>
    <div class="p-3">
      <a href="/userauth/forgot">Quên mật khẩu?</a>
    </div>
    <div>
      <p>Bạn giờ mới biết đến Eshopper? <a href="/userauth/register">Đăng ký</a></p>
    </div>
  </div>

  <script>
    const form = document.getElementById("user-login");
    const errorMsg = document.getElementById("user-loginerror");
    const loginButton = document.getElementById("user-loginbutton");

    function parseJwt(token) {
      var base64Url = token.split('.')[1];
      var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function (c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));

      return JSON.parse(jsonPayload);
    }

    form.addEventListener("keydown", (event) => {
      if (event.key === "Enter") {
        event.preventDefault(); // Ngăn chặn hành động mặc định của phím Enter (ví dụ: submit form)
        loginButton.click(); // Kích hoạt sự kiện click trên nút loginButton
      }
    });

    loginButton.addEventListener("click", () => {
      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());
      console.log("bind xong");
      fetch("/auth/login", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(data),
      }).then((res) => {
        if (res.ok) {
          res.json().then((data) => {
            localStorage.setItem("jwt", JSON.stringify(data));
            document.cookie =
              "AUTHORIZATION=Bearer " + data.token + ";path=/;expires=max-age";
            const info = parseJwt(data.token)
            fetch('/user/get?id=' + info.userId).then(res => {
              if (res.ok) {
                res.json().then(userInfo => {
                  localStorage.setItem("user", JSON.stringify(userInfo))
                  location.href = "/eshopper/store";
                })
              }
            })
          });
        } else {
          error.style.display = "unset";
        }
      });
    });
  </script>

</div>