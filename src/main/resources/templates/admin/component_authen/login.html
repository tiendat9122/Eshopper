<!-- START Page Container -->
<div id="page-container" th:fragment="adminAuthen">
    <!-- Main Container -->
    <main id="main-container">
        <!-- Page Content -->
        <div class="hero-static d-flex align-items-center">
            <div class="w-100">
                <!-- Sign In Section -->
                <div class="bg-white">
                    <div class="content content-full">
                        <div class="row justify-content-center">
                            <div class="col-md-8 col-lg-6 col-xl-4 py-4">
                                <!-- Header -->
                                <div class="text-center">
                                    <p class="mb-2">
                                        <i class="fa fa-2x fa-circle-notch text-primary"></i>
                                    </p>
                                    <h1 class="h4 mb-1">Đăng nhập</h1>
                                    <h2 class="h6 font-w400 text-muted mb-3"> Hệ thống quản lý cửa hàng bán sách
                                        Eshopper </h2>
                                </div>
                                <!-- END Header -->
                                <div id="error" style="display: none">
                                    <div class="text-center">
                                        <p class="text-danger">sai thông tin đăng nhập</p>
                                    </div>
                                </div>
                                <!-- Sign In Form -->
                                <!-- jQuery Validation (.js-validation-signin class is initialized in js/pages/op_auth_signin.min.js which was auto compiled from _es6/pages/op_auth_signin.js) -->
                                <!-- For more info and examples you can check out https://github.com/jzaefferer/jquery-validation -->
                                <form id="login" class="js-validation-signin" action="be_pages_auth_all.html">
                                    <div class="py-3">
                                        <div class="form-group">
                                            <input type="text" class="form-control form-control-lg form-control-alt"
                                                id="login-username" name="email" placeholder="Tên đăng nhập" />
                                        </div>
                                        <div class="form-group">
                                            <input type="password" class="form-control form-control-lg form-control-alt"
                                                id="login-password" name="password" placeholder="Mật khẩu" />
                                        </div>
                                        <div class="form-group">
                                            <div class="d-md-flex align-items-md-center justify-content-md-between">
                                                <div class="custom-control custom-switch">
                                                    <input type="checkbox" class="custom-control-input"
                                                        id="login-remember" name="login-remember" />
                                                    <label class="custom-control-label font-w400"
                                                        for="login-remember">Nhớ mật khẩu</label>
                                                </div>
                                                <div class="py-2">
                                                    <a class="font-size-sm font-w500" href="/admin/forgot">Quên mật
                                                        khẩu?</a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group row justify-content-center mb-0">
                                        <div class="col-md-6 col-xl-5">
                                            <button id="login-button" type="button" class="btn btn-block btn-primary">
                                                <i class="fa fa-fw fa-sign-in-alt mr-1"></i> Đăng nhập
                                            </button>
                                        </div>
                                    </div>
                                </form>
                                <!-- END Sign In Form -->
                            </div>
                        </div>
                    </div>
                </div>
                <!-- END Sign In Section -->

                <!-- Footer -->
                <div class="font-size-sm text-center text-muted py-3">
                    <strong>Eshopper</strong> &copy;
                    <span data-toggle="year-copy"></span>
                </div>
                <!-- END Footer -->
            </div>
        </div>
        <!-- END Page Content -->
    </main>
    <!-- END Main Container -->
</div>
<!-- END Page Container -->


<script th:fragment="adminScript_after">
    const form = document.getElementById("login");
    const errorMsg = document.getElementById("error");
    const loginButton = document.getElementById("login-button");

    function parseJwt(token) {
        var base64Url = token.split('.')[1];
        var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function (c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));

        return JSON.parse(jsonPayload);
    }

    form.addEventListener("keydown", (event) => {
        if (event.key === "Enter") {
            event.preventDefault(); // Ngăn chặn hành động mặc định của phím Enter (ví dụ: submit form)
            loginButton.click(); // Kích hoạt sự kiện click trên nút loginButton
        }
    });

    loginButton.addEventListener("click", () => {
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        console.log("bind xong");
        fetch("/auth/login", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify(data),
        }).then((res) => {
            if (res.ok) {
                res.json().then((data) => {
                    localStorage.setItem("jwt", JSON.stringify(data));
                    document.cookie =
                        "AUTHORIZATION=Bearer " + data.token + ";path=/;expires=max-age";
                    const info = parseJwt(data.token)
                    fetch('/user/get?id=' + info.userId).then(res => {
                        if (res.ok) {
                            res.json().then(userInfo => {
                                localStorage.setItem("user", JSON.stringify(userInfo))
                                location.href = "/admin/product";
                            })
                        }
                    })
                });
            } else {
                error.style.display = "unset";
            }
        });
    });

</script>